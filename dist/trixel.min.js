function Trixel(a,b){b=b||{};b.paving||Trixel.ISO;switch(this.canvas=new Canvas(a),this.paving){default:b.canvas=this.canvas,this.paving=new Iso(b)}this.paving.draw(),this.matrix=this.paving.matrix}function Canvas(a){this.elem=a,this.ctx=this.elem.getContext("2d"),this.width=a.width,this.height=a.height}function Color(a,b,c,d,e){switch(this.a=parseFloat(Math.round(100*d)/100||1),e){case Color.HSL:this.h=parseFloat(a||0),this.s=parseFloat(b||0),this.l=parseFloat(c||0),this.loadRGB();break;default:this.r=parseInt(a||0),this.g=parseInt(b||0),this.b=parseInt(c||0),this.loadHSL()}}function Iso(a){a=a||{},void 0==a.canvas?console.log("ISO error: no canvas"):this.canvas=a.canvas,this.style=a.style||Iso.HORIZONTAL,this.strate=this.getStrate(a.strate||"20%");var b=this.strate,c=this.side=b/Math.cos(30*Math.PI/180),d=c/2,e=this.canvas.width,f=this.canvas.height;this.orientation=this.style==Iso.VERTICAL?90:0,this.rayon=d/Math.sin(60*Math.PI/180),this.mayon=b-this.rayon,this.matrix={},this.matrix.sizeX=this.style==Iso.VERTICAL?Math.ceil(e/b):Math.ceil(e/d)+1,this.matrix.sizeY=this.style==Iso.VERTICAL?Math.ceil(f/c*2)+1:Math.ceil(f/b),console.log("sizeX:"+this.matrix.sizeX+", sizeY:"+this.matrix.sizeY),this.matrix.data=new Array(this.matrix.sizeX);for(var g=0;g<this.matrix.sizeX;g++){this.matrix.data[g]=new Array(this.matrix.sizeY);for(var h=0;h<this.matrix.sizeY;h++)this.matrix.data[g][h]=new Uint8Array(3)}console.log(this.matrix.sizeX*this.matrix.sizeY)}Trixel.ISO="iso",Trixel.HPLAN="Hplan",Trixel.RAND="rand",Trixel.IMG="image",Trixel.prototype.colorMap=function(a,b){var c=(new Date).getTime();switch(a){case Trixel.RAND:this.colorMapRAND(a,b);break;case Trixel.IMG:this.colorMapIMG(a,b);break;default:this.colorMapHPLAN(a)}console.log(a+" : "+((new Date).getTime()-c)+" milli")},Trixel.prototype.colorMapRAND=function(a,b){for(var c=this.matrix,d=0;d<c.sizeX;d++)for(var e=0;e<c.sizeY;e++){var f=255*Math.random(),g=255*Math.random(),h=255*Math.random(),i=new Color(h,f,g);b.colors.length>0&&(i=b.colors[Math.floor(Math.random()*b.colors.length)]),this.paving.setIxel({x:d,y:e},i)}},Trixel.prototype.colorMapHPLAN=function(){for(var a=this.matrix,b=0;b<a.sizeX;b++)for(var c=0;c<a.sizeY;c++){var d=255*b/a.sizeX,e=255*c/a.sizeY,f=255-d,g=255-e,h=2*(e-127.5),i=255-Math.sqrt(d*d+e*e),j=255-Math.sqrt(d*d+g*g),k=255-Math.sqrt(f*f+h*h);i=0>i?0:i,j=0>j?0:j,k=0>k?0:k,this.paving.setIxel({x:b,y:c},new Color(k,i,j))}},Trixel.prototype.colorMapIMG=function(a,b){function c(a,b){var c=4*b,d=a.data;return[d[c],d[c+1],d[c+2],d[c+3]/255]}function d(a,b){return c(a,b.y*a.width+b.x)}var e=this,f=this.matrix,g=new Image;g.src=b.src,g.onload=function(){var a=(new Date).getTime(),b=document.createElement("canvas");b.width=f.sizeX,b.height=f.sizeY;var c=b.getContext("2d");c.drawImage(g,0,0,b.width,b.height);for(var h=c.getImageData(0,0,b.width,b.height),i=0;i<f.sizeX;i++)for(var j=0;j<f.sizeY;j++){var k=e.paving.getCanvasPoint({x:i,y:j});k={x:k.x/e.canvas.width*b.width,y:k.y/e.canvas.height*b.height},k={x:k.x>b.width?b.width:k.x<0?0:Math.floor(k.x),y:k.y>b.height?b.height:k.y<0?0:Math.floor(k.y)};{var l=d(h,k),m=new Color(l[0],l[1],l[2],l[3]);Color.bind.apply(Color,m)}e.paving.setIxel({x:i,y:j},m)}console.log(Trixel.IMG+" : "+((new Date).getTime()-a)+" milli")}},Trixel.prototype.setIxel=function(a,b){this.paving.setIxel(a,b)},Canvas.prototype.clear=function(){this.ctx.clearRect(-this.width,-this.height,this.width,this.height)},Canvas.prototype.path=function(a,b){this.ctx.beginPath(),this.ctx.moveTo(a[0].x,a[0].y);for(var c=1;c<a.length;c++)this.ctx.lineTo(a[c].x,a[c].y);this.ctx.closePath(),this.ctx.save(),this.ctx.globalAlpha=b.a,this.ctx.fillStyle=this.ctx.strokeStyle=b.toHex(),this.ctx.stroke(),this.ctx.fill(),this.ctx.restore()},Color.HSL="hsl",Color.RGB="rgb",Color.prototype.toHex=function(){var a=(256*this.r*256+256*this.g+this.b).toString(16);return a.length<6&&(a=new Array(6-a.length+1).join("0")+a),"#"+a},Color.prototype.lighten=function(a,b){b=b||new Color(255,255,255);var c=new Color(b.r/255*this.r,b.g/255*this.g,b.b/255*this.b,this.a);return c.l=Math.min(c.l+a,1),c.loadRGB(),c},Color.prototype.loadHSL=function(){var a,b,c=this.r/255,d=this.g/255,e=this.b/255,f=Math.max(c,d,e),g=Math.min(c,d,e),h=(f+g)/2;if(f===g)a=b=0;else{var i=f-g;switch(b=h>.5?i/(2-f-g):i/(f+g),f){case c:a=(d-e)/i+(e>d?6:0);break;case d:a=(e-c)/i+2;break;case e:a=(c-d)/i+4}a/=6}this.h=a,this.s=b,this.l=h},Color.prototype.loadRGB=function(){var a,b,c,d=this.h,e=this.s,f=this.l;if(0===e)a=b=c=f;else{var g=.5>f?f*(1+e):f+e-f*e,h=2*f-g;a=this._hue2rgb(h,g,d+1/3),b=this._hue2rgb(h,g,d),c=this._hue2rgb(h,g,d-1/3)}this.r=parseInt(255*a),this.g=parseInt(255*b),this.b=parseInt(255*c)},Color.prototype._hue2rgb=function(a,b,c){return 0>c&&(c+=1),c>1&&(c-=1),1/6>c?a+6*(b-a)*c:.5>c?b:2/3>c?a+(b-a)*(2/3-c)*6:a},Iso.HORIZONTAL="horizontal",Iso.VERTICAL="vertical",Iso.prototype.getStrate=function(a){if(-1!=a.indexOf("%")){a=parseInt(a)||20;var b=this.style==Iso.VERTICAL?this.canvas.width:this.canvas.height;return b*a/100}return-1!=a.indexOf("px")?parseInt(a)||20:parseInt(a)||20},Iso.prototype.draw=function(){var a=(new Date).getTime();this.canvas.clear();for(var b=0;b<this.matrix.sizeX;b++)for(var c=0;c<this.matrix.sizeY;c++){var d=Color.bind.apply(Color,this.matrix.data[b][c]);this.setIxel({x:b,y:c},new d)}console.log("draw : "+((new Date).getTime()-a)+" milli")},Iso.prototype.setIxel=function(a,b){var c=this.orientation,d=this.rayon,e=this.getCanvasPoint(a),f=180;Math.floor((a.x+a.y)/2)!=(a.x+a.y)/2&&(f=0);for(var g=new Array(3),h=0;3>h;h++){pa=(120*(h+.5)+c+f)*Math.PI/180;var i=Math.sin(pa)*d,j=Math.cos(pa)*d;g[h]={x:i+e.x,y:j+e.y}}this.matrix.data[a.x][a.y]=[b.r,b.g,b.b],this.canvas.path(g,b)},Iso.prototype.getCanvasPoint=function(a){var b=this.strate,c=this.side/2,d=this.mayon,e=this.style==Iso.VERTICAL?a.x*b+d:a.x*c,f=this.style==Iso.VERTICAL?a.y*c:a.y*b+d;return Math.floor((a.x+a.y)/2)!=(a.x+a.y)/2&&(e+=this.style==Iso.VERTICAL?d:0,f+=this.style==Iso.VERTICAL?0:d),{x:e,y:f}};